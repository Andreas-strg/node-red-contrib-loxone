<script type="text/x-red" data-help-name="loxone-in">
    <p>bla bla</p>

</script>


<script type="text/javascript">

    var miniserverStructure = {};

    RED.nodes.registerType('loxone-in', {
        category: 'input',
        color: '#83B817',
        defaults: {
            name: {value: ''},
            miniserver: {type: 'loxone-miniserver', required: true},
            control: {value: '', required: true},
            controlName: {value: ''}, //TODO: take from structure file
            stateName: {value: ''}, //TODO: take from structure file
            uuid: {value: '', required: true}
        },
        inputs: 0,
        outputs: 1,
        icon: "loxone.png",
        label: function () {
            return this.name || "loxone";
        },
        oneditprepare: function () {
            $('#node-input-loadstruct').on('click', loadStructureFile);
            //TODO: check for already loaded structure and select the saved uuid
        },
        oneditsave: function () {

            //not needed it taken from structure file
            this.controlName = $('#node-input-control option:selected').text();
            this.stateName = $('#node-input-uuid option:selected').text();

            disableChangeEvents();
        },
        oneditcancel: function () {
            disableChangeEvents();
        }
    });

    function loadStructureFile() {

        var configNodeId = $('#node-input-miniserver').val();

        var url = '/struct?id=' + configNodeId;

        $.getJSON(url).done(function (data) {

            //console.log(data);

            if (data.state == 'ok') {
                miniserverStructure = data.structure;

                var $roomSelect = $('#node-input-room');
                var $categorySelect = $('#node-input-category');
                var $controlSelect = $('#node-input-control');
                var uuid;

                $roomSelect.empty();
                $categorySelect.empty();
                $controlSelect.empty();

                if (
                    typeof data.structure.rooms != 'undefined' &&
                    typeof data.structure.categories != 'undefined' &&
                    typeof data.structure.controls != 'undefined'
                ) {
                    //populate form elements
                    $roomSelect.append('<option value=""></option>');
                    for (uuid in data.structure.rooms) {
                        if (data.structure.rooms.hasOwnProperty(uuid)) {
                            $roomSelect.append('<option value="' + uuid + '">' +
                                data.structure.rooms[uuid] +
                                '</option>');
                        }
                    }

                    $categorySelect.append('<option value=""></option>');
                    for (uuid in data.structure.categories) {
                        if (data.structure.categories.hasOwnProperty(uuid)) {
                            $categorySelect.append('<option value="' + uuid + '">' +
                                data.structure.categories[uuid] +
                                '</option>');
                        }
                    }

                    $controlSelect.append('<option value=""></option>');
                    for (uuid in data.structure.controls) {
                        if (data.structure.controls.hasOwnProperty(uuid)) {
                            $controlSelect.append('<option value="' + uuid + '">' +
                                data.structure.controls[uuid].name +
                                '</option>');
                        }
                    }
                }

                $('#node-input-room, #node-input-category').on('change', fillControl);
                $controlSelect.on('change', fillState);
            }

            $('#return-msg').text(data.msg);


        });


    }

    function fillControl(e) {

        var $roomSelect = $('#node-input-room');
        var $categorySelect = $('#node-input-category');
        var $controlSelect = $('#node-input-control');
        $controlSelect.off('change');

        var roomVal = $roomSelect.val();
        var categoryVal = $categorySelect.val();

        $controlSelect.empty();

        //console.log(miniserverStructure);

        var options = [];
        for (var uuid in miniserverStructure.controls) {
            if (
                miniserverStructure.controls.hasOwnProperty(uuid) &&
                ((roomVal.length && miniserverStructure.controls[uuid].room == roomVal) || !roomVal.length) &&
                ((categoryVal.length && miniserverStructure.controls[uuid].cat == categoryVal) || !categoryVal.length)
            ) {
                options.push('<option value="' + uuid + '">' + miniserverStructure.controls[uuid].name + '</option>');
            }
        }

        if (options.length > 1) {
            $controlSelect.append('<option value=""></option>');
        }
        $controlSelect.append(options.join(''));

        if (options.length == 1) {
            $controlSelect.trigger('change');
        }

    }

    function fillState(e) {
        var $stateSelect = $('#node-input-uuid');
        $stateSelect.empty();
        $stateSelect.append('<option value=""></option>');

        if (typeof miniserverStructure.controls[this.value] != 'undefined') {

            var control = miniserverStructure.controls[this.value];

            for (var statename in control.states) {
                if (control.states.hasOwnProperty(statename)) {
                    $stateSelect.append(
                        '<option value="' + control.states[statename] + '">' +
                        statename +
                        '</option>');
                }
            }
        }

    }

    function disableChangeEvents() {
        $('#node-input-room, #node-input-category, #node-input-control').off('change');
    }
</script>

<script type="text/x-red" data-template-name="loxone-in">

    <div class="form-row">
        <label for="node-input-miniserver">
            <i class="fa fa-globe"></i>
            Miniserver
        </label>
        <input type="text" id="node-input-miniserver">
    </div>

    <div class="form-row">
        <label for="node-input-loadstruct">
        </label>
        <button type="button" id="node-input-loadstruct" class="btn">
            <i class="icon-refresh"></i>
            Load Miniserver Structure
        </button>
    </div>

    <div class="form-row">
        <label for="node-input-room">
            <i class="icon-home"></i>
            Room
        </label>
        <select id="node-input-room">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-category">
            <i class="icon-list"></i>
            Category
        </label>
        <select id="node-input-category">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-control">
            <i class="icon-cog"></i>
            Control
        </label>
        <select id="node-input-control">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-uuid">
            <i class="fa fa-sticky-note-o" ></i>
            State
        </label>
        <select id="node-input-uuid">
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <span id="return-msg"></span>
    </div>





</script>


<script type="text/javascript">
    RED.nodes.registerType('loxone-miniserver', {
        category: 'config',
        defaults: {
            host: {value: "", required: true},
            port: {value: 80, required: true, validate: RED.validators.number()},
        },
        credentials: {
            username: {type: "text", required: true},
            password: {type: "password", required: true}
        },
        label: function () {
            return this.host;
        }
    });
</script>

<script type="text/x-red" data-template-name="loxone-miniserver">

    <div class="form-row node-input-broker">
        <label for="node-config-input-broker">
            <i class="fa fa-globe"></i> Miniserver
        </label>
        <input class="input-append-left" type="text" id="node-config-input-host" placeholder="hostname/ip" style="width: 40%;" >

        <label for="node-config-input-port" style="margin-left: 10px; width: 35px;">
            Port
        </label>
        <input type="text" id="node-config-input-port" style="width:45px" placeholder="80">
    </div>

    <div class="form-row">
        <label for="node-config-input-username"><i class="fa fa-user"></i> User</label>
        <input type="text" id="node-config-input-username">
    </div>
    <div class="form-row">
        <label for="node-config-input-port"><i class="fa fa-lock"></i> Password</label>
        <input type="password" id="node-config-input-password">
    </div>

</script>


